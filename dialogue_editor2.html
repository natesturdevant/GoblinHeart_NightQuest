<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Goblinheart Dialogue Editor v2</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        * { box-sizing: border-box; }
        
        body {
            margin: 0;
            padding: 20px;
            font-family: 'Press Start 2P', monospace;
            background-color: #000;
            color: #0f0;
            font-size: 10px;
            line-height: 1.6;
        }
        
        h1 {
            text-align: center;
            color: #0ff;
            font-size: 16px;
            margin-bottom: 20px;
            text-shadow: 2px 2px 0 #055;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 20px;
        }
        
        .panel {
            background-color: #001;
            border: 2px solid #0f0;
            padding: 15px;
        }
        
        .panel h2 {
            font-size: 11px;
            color: #0ff;
            margin: 0 0 15px 0;
            border-bottom: 1px solid #0f0;
            padding-bottom: 8px;
        }
        
        .npc-list {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .npc-item {
            padding: 8px;
            margin: 5px 0;
            background-color: #002;
            border: 1px solid #050;
            cursor: pointer;
            font-size: 9px;
        }
        
        .npc-item:hover {
            background-color: #003;
            border-color: #0a0;
        }
        
        .npc-item.selected {
            background-color: #004;
            border: 2px solid #0ff;
        }
        
        .button {
            background-color: #003;
            color: #0f0;
            border: 2px solid #0f0;
            padding: 8px 15px;
            margin: 5px;
            cursor: pointer;
            font-family: 'Press Start 2P', monospace;
            font-size: 8px;
            transition: all 0.2s;
        }
        
        .button:hover {
            background-color: #005;
            border-color: #0ff;
        }
        
        .button.danger {
            border-color: #f00;
            color: #f00;
        }
        
        .button.danger:hover {
            background-color: #300;
        }
        
        input, textarea, select {
            width: 100%;
            background-color: #001;
            color: #0f0;
            border: 1px solid #0f0;
            padding: 8px;
            font-family: 'Press Start 2P', monospace;
            font-size: 8px;
            margin: 5px 0;
        }
        
        label {
            display: block;
            color: #ff0;
            font-size: 8px;
            margin: 10px 0 5px 0;
        }
        
        .dialogue-line {
            background-color: #002;
            border: 2px solid #050;
            padding: 12px;
            margin: 10px 0;
            position: relative;
        }
        
        .dialogue-line.selected {
            border-color: #0ff;
        }
        
        .dialogue-line-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 1px solid #050;
        }
        
        .line-number {
            color: #ff0;
            font-size: 9px;
        }
        
        .line-buttons {
            display: flex;
            gap: 5px;
        }
        
        .small-button {
            padding: 4px 8px;
            font-size: 7px;
        }
        
        .requirement-group {
            background-color: #001;
            border: 1px solid #050;
            padding: 8px;
            margin: 5px 0;
        }
        
        .requirement-item {
            display: flex;
            gap: 10px;
            align-items: center;
            margin: 5px 0;
            padding: 5px;
            background-color: #002;
            border: 1px solid #030;
        }
        
        .flag-input {
            flex: 1;
        }
        
        .flag-name {
            color: #0ff;
            font-size: 8px;
            min-width: 120px;
        }
        
        .flag-value {
            color: #ff0;
            font-size: 8px;
            min-width: 60px;
        }
        
        .export-area {
            margin-top: 20px;
        }
        
        textarea.export {
            min-height: 300px;
            font-family: 'Courier New', monospace;
            font-size: 9px;
        }
        
        .button-row {
            display: flex;
            gap: 10px;
            margin: 10px 0;
            flex-wrap: wrap;
        }
        
        .help {
            background-color: #002;
            border: 1px solid #050;
            padding: 10px;
            margin: 15px 0;
            font-size: 7px;
            color: #888;
            line-height: 1.8;
        }
        
        .empty-state {
            text-align: center;
            color: #555;
            padding: 40px;
            font-size: 9px;
        }

        .quick-flags {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
            margin: 10px 0;
        }

        .quick-flag-btn {
            padding: 4px 8px;
            font-size: 6px;
            background-color: #002;
            color: #0ff;
            border: 1px solid #055;
        }

        .quick-flag-btn:hover {
            background-color: #004;
        }

        .dialogue-preview {
            background-color: #001;
            border: 1px solid #050;
            padding: 10px;
            margin: 10px 0;
            font-size: 7px;
            color: #888;
        }

        .preview-title {
            color: #0ff;
            font-size: 8px;
            margin-bottom: 5px;
        }

        .conversation-tree {
            margin-left: 20px;
            padding-left: 10px;
            border-left: 1px solid #050;
        }
    </style>
</head>
<body>
    <h1>GOBLINHEART DIALOGUE EDITOR v2</h1>
    
    <div class="container">
        <!-- Left Panel - NPC List -->
        <div class="panel">
            <h2>NPCs</h2>
            <div class="button-row">
                <button class="button small-button" onclick="addNPC()">+ New NPC</button>
                <button class="button small-button" onclick="duplicateNPC()">Clone</button>
                <button class="button danger small-button" onclick="deleteNPC()">Delete</button>
            </div>
            <div class="npc-list" id="npcList"></div>
            
            <div class="export-area">
                <h2>Import/Export</h2>
                <button class="button" onclick="exportDialogue()">Export JSON</button>
                <button class="button" onclick="importDialogue()">Import JSON</button>
                <button class="button" onclick="showUsedFlags()">Show All Flags</button>
                <textarea class="export" id="exportArea" placeholder="JSON will appear here..."></textarea>
            </div>
        </div>
        
        <!-- Right Panel - NPC Editor -->
        <div class="panel">
            <div id="editorArea">
                <div class="empty-state">
                    Select an NPC from the list or create a new one
                </div>
            </div>
        </div>
    </div>

    <script>
        let dialogueData = {};
        let currentNPC = null;
        let currentLineIndex = null;
        
        // Common flags that can be quickly added
        const COMMON_FLAGS = ['quest_started', 'quest_complete', 'talked_before', 'helped_player'];
        
        function init() {
            renderNPCList();
        }
        
        function addNPC() {
            const id = prompt("Enter NPC ID (e.g., 'blacksmith_john'):");
            if (!id) return;
            
            if (dialogueData[id]) {
                alert("NPC with this ID already exists!");
                return;
            }
            
            dialogueData[id] = {
                name: prompt("Enter NPC display name:", id.charAt(0).toUpperCase() + id.slice(1)) || id,
                sprite: prompt("Enter sprite name:", "villager") || "villager",
                isShopkeeper: confirm("Is this NPC a shopkeeper?"),
                lines: [
                    {
                        text: "Hello, traveler.",
                        requires: {},
                        sets: { talked_before: true }
                    }
                ]
            };
            
            renderNPCList();
            selectNPC(id);
        }

        function duplicateNPC() {
            if (!currentNPC) {
                alert("No NPC selected!");
                return;
            }
            
            const newId = prompt("Enter new NPC ID:", currentNPC + "_copy");
            if (!newId || dialogueData[newId]) {
                alert("Invalid ID or already exists!");
                return;
            }
            
            dialogueData[newId] = JSON.parse(JSON.stringify(dialogueData[currentNPC]));
            dialogueData[newId].name += " (Copy)";
            
            renderNPCList();
            selectNPC(newId);
        }
        
        function deleteNPC() {
            if (!currentNPC) {
                alert("No NPC selected!");
                return;
            }
            
            if (confirm(`Delete NPC "${currentNPC}"?`)) {
                delete dialogueData[currentNPC];
                currentNPC = null;
                renderNPCList();
                document.getElementById('editorArea').innerHTML = '<div class="empty-state">NPC deleted. Select another or create new.</div>';
            }
        }
        
        function renderNPCList() {
            const list = document.getElementById('npcList');
            list.innerHTML = '';
            
            Object.keys(dialogueData).sort().forEach(id => {
                const div = document.createElement('div');
                div.className = 'npc-item' + (id === currentNPC ? ' selected' : '');
                
                const npc = dialogueData[id];
                const lineCount = npc.lines.length;
                const shopTag = npc.isShopkeeper ? ' [SHOP]' : '';
                
                div.textContent = `${npc.name} (${lineCount})${shopTag}`;
                div.onclick = () => selectNPC(id);
                list.appendChild(div);
            });
        }
        
        function selectNPC(id) {
            currentNPC = id;
            currentLineIndex = null;
            renderNPCList();
            renderEditor();
        }
        
        function renderEditor() {
            const editor = document.getElementById('editorArea');
            const npc = dialogueData[currentNPC];
            
            editor.innerHTML = `
                <h2>${npc.name} (${currentNPC})</h2>
                
                <label>NPC Name:</label>
                <input type="text" value="${npc.name}" onchange="updateNPCName(this.value)">
                
                <label>Sprite:</label>
                <input type="text" value="${npc.sprite}" onchange="updateNPCSprite(this.value)">
                
                <label>
                    <input type="checkbox" ${npc.isShopkeeper ? 'checked' : ''} onchange="updateShopkeeper(this.checked)">
                    Is Shopkeeper
                </label>
                
                <div class="dialogue-preview">
                    <div class="preview-title">Conversation Flow Preview:</div>
                    <div id="conversationTree"></div>
                </div>
                
                <h2>Dialogue Lines</h2>
                <div class="help">
                    Lines are checked from BOTTOM to TOP. Most specific conditions should be at the BOTTOM.<br>
                    Use {{variable}} syntax for player.level, player.gold, etc.<br>
                    Common pattern: Generic greeting → Returning visitor → Quest progression
                </div>
                
                <button class="button" onclick="addLine()">+ Add Dialogue Line</button>
                
                <div id="dialogueLines"></div>
            `;
            
            renderConversationTree();
            renderLines();
        }
        
        function renderConversationTree() {
            const container = document.getElementById('conversationTree');
            const npc = dialogueData[currentNPC];
            
            let tree = '';
            npc.lines.forEach((line, idx) => {
                const reqText = getRequirementsText(line.requires);
                const setsText = getSetsText(line.sets);
                
                tree += `<div style="margin: 5px 0; padding: 5px; background: #002; border-left: 2px solid ${idx === currentLineIndex ? '#0ff' : '#050'};">`;
                tree += `<span style="color: #ff0;">[${idx + 1}]</span> `;
                tree += `<span style="color: #0f0;">${line.text.substring(0, 50)}${line.text.length > 50 ? '...' : ''}</span><br>`;
                if (reqText) tree += `<span style="color: #f80; font-size: 6px;">IF: ${reqText}</span><br>`;
                if (setsText) tree += `<span style="color: #0ff; font-size: 6px;">THEN: ${setsText}</span>`;
                tree += `</div>`;
            });
            
            container.innerHTML = tree || '<span style="color: #555;">No lines yet</span>';
        }
        
        function getRequirementsText(req) {
            if (!req) return '';
            const parts = [];
            if (req.level) parts.push(`Lv${req.level}+`);
            if (req.gold) parts.push(`${req.gold}G+`);
            if (req.hasItem) parts.push(`Has ${req.hasItem}`);
            if (req.flags) {
                Object.entries(req.flags).forEach(([flag, val]) => {
                    parts.push(`${flag}=${val}`);
                });
            }
            return parts.join(', ');
        }
        
        function getSetsText(sets) {
            if (!sets) return '';
            return Object.entries(sets).map(([flag, val]) => `${flag}=${val}`).join(', ');
        }
        
        function renderLines() {
            const container = document.getElementById('dialogueLines');
            if (!container) return;
            
            const npc = dialogueData[currentNPC];
            container.innerHTML = '';
            
            npc.lines.forEach((line, idx) => {
                const div = document.createElement('div');
                div.className = 'dialogue-line' + (idx === currentLineIndex ? ' selected' : '');
                div.innerHTML = `
                    <div class="dialogue-line-header">
                        <span class="line-number">Line ${idx + 1} (Priority: ${npc.lines.length - idx})</span>
                        <div class="line-buttons">
                            ${idx > 0 ? `<button class="button small-button" onclick="moveLine(${idx}, -1)">↑</button>` : ''}
                            ${idx < npc.lines.length - 1 ? `<button class="button small-button" onclick="moveLine(${idx}, 1)">↓</button>` : ''}
                            <button class="button small-button" onclick="duplicateLine(${idx})">Copy</button>
                            <button class="button danger small-button" onclick="deleteLine(${idx})">Delete</button>
                        </div>
                    </div>
                    
                    <label>Dialogue Text:</label>
                    <textarea rows="3" onchange="updateLineText(${idx}, this.value)">${line.text}</textarea>
                    
                    <label>Requirements (When to show this):</label>
                    <div class="requirement-group">
                        <div class="requirement-item">
                            <label style="width: 100px;">Min Level:</label>
                            <input type="number" value="${line.requires?.level || ''}" 
                                   onchange="updateRequirement(${idx}, 'level', this.value)" 
                                   placeholder="Any level">
                        </div>
                        
                        <div class="requirement-item">
                            <label style="width: 100px;">Min Gold:</label>
                            <input type="number" value="${line.requires?.gold || ''}" 
                                   onchange="updateRequirement(${idx}, 'gold', this.value)"
                                   placeholder="Any amount">
                        </div>
                        
                        <div class="requirement-item">
                            <label style="width: 100px;">Has Item:</label>
                            <input type="text" value="${line.requires?.hasItem || ''}" 
                                   onchange="updateRequirement(${idx}, 'hasItem', this.value)"
                                   placeholder="item_id">
                        </div>
                        
                        <label>Required Flags:</label>
                        <div id="flags_${idx}"></div>
                        <button class="button small-button" onclick="addFlag(${idx})">+ Add Flag Requirement</button>
                    </div>
                    
                    <label>Sets Flags (When player sees this):</label>
                    <div class="quick-flags">
                        ${COMMON_FLAGS.map(flag => 
                            `<button class="button quick-flag-btn" onclick="quickAddSetFlag(${idx}, '${flag}')">${flag}</button>`
                        ).join('')}
                    </div>
                    <div id="setflags_${idx}"></div>
                    <button class="button small-button" onclick="addSetFlag(${idx})">+ Custom Flag</button>
                `;
                
                container.appendChild(div);
                
                renderFlags(idx);
                renderSetFlags(idx);
            });
            
            renderConversationTree();
        }
        
        function renderFlags(lineIdx) {
            const container = document.getElementById(`flags_${lineIdx}`);
            const line = dialogueData[currentNPC].lines[lineIdx];
            
            if (!line.requires.flags || Object.keys(line.requires.flags).length === 0) {
                container.innerHTML = '<div style="color: #555; font-size: 7px; padding: 5px;">No flag requirements</div>';
                return;
            }
            
            container.innerHTML = '';
            Object.entries(line.requires.flags).forEach(([flag, value]) => {
                const div = document.createElement('div');
                div.className = 'requirement-item';
                div.innerHTML = `
                    <span class="flag-name">${flag}</span>
                    <span style="color: #888; font-size: 7px;">must be</span>
                    <select class="flag-value" onchange="updateFlagValue(${lineIdx}, '${flag}', this.value)">
                        <option value="true" ${value === true ? 'selected' : ''}>true</option>
                        <option value="false" ${value === false ? 'selected' : ''}>false</option>
                    </select>
                    <button class="button danger small-button" onclick="deleteFlag(${lineIdx}, '${flag}')">X</button>
                `;
                container.appendChild(div);
            });
        }
        
        function renderSetFlags(lineIdx) {
            const container = document.getElementById(`setflags_${lineIdx}`);
            const line = dialogueData[currentNPC].lines[lineIdx];
            
            if (!line.sets || Object.keys(line.sets).length === 0) {
                container.innerHTML = '<div style="color: #555; font-size: 7px; padding: 5px;">No flags set</div>';
                return;
            }
            
            container.innerHTML = '';
            Object.entries(line.sets).forEach(([flag, value]) => {
                const div = document.createElement('div');
                div.className = 'requirement-item';
                div.innerHTML = `
                    <span class="flag-name">${flag}</span>
                    <span style="color: #888; font-size: 7px;">→</span>
                    <select class="flag-value" onchange="updateSetFlagValue(${lineIdx}, '${flag}', this.value)">
                        <option value="true" ${value === true ? 'selected' : ''}>true</option>
                        <option value="false" ${value === false ? 'selected' : ''}>false</option>
                    </select>
                    <button class="button danger small-button" onclick="deleteSetFlag(${lineIdx}, '${flag}')">X</button>
                `;
                container.appendChild(div);
            });
        }
        
        function updateNPCName(value) {
            dialogueData[currentNPC].name = value;
            renderNPCList();
        }
        
        function updateNPCSprite(value) {
            dialogueData[currentNPC].sprite = value;
        }
        
        function updateShopkeeper(checked) {
            dialogueData[currentNPC].isShopkeeper = checked;
            renderNPCList();
        }
        
        function updateLineText(idx, value) {
            dialogueData[currentNPC].lines[idx].text = value;
            renderConversationTree();
        }
        
        function updateRequirement(idx, key, value) {
            const line = dialogueData[currentNPC].lines[idx];
            if (!line.requires) line.requires = {};
            
            if (value === '' || value === null) {
                delete line.requires[key];
            } else {
                line.requires[key] = key === 'level' || key === 'gold' ? parseInt(value) : value;
            }
            renderConversationTree();
        }
        
        function addFlag(idx) {
            const line = dialogueData[currentNPC].lines[idx];
            if (!line.requires.flags) line.requires.flags = {};
            
            const flagName = prompt("Enter flag name:");
            if (!flagName) return;
            
            line.requires.flags[flagName] = true;
            renderLines();
        }
        
        function updateFlagValue(idx, flag, value) {
            const line = dialogueData[currentNPC].lines[idx];
            line.requires.flags[flag] = value === 'true';
            renderLines();
        }
        
        function deleteFlag(idx, flag) {
            const line = dialogueData[currentNPC].lines[idx];
            delete line.requires.flags[flag];
            if (Object.keys(line.requires.flags).length === 0) {
                delete line.requires.flags;
            }
            renderLines();
        }
        
        function quickAddSetFlag(idx, flagName) {
            const line = dialogueData[currentNPC].lines[idx];
            if (!line.sets) line.sets = {};
            line.sets[flagName] = true;
            renderLines();
        }
        
        function addSetFlag(idx) {
            const line = dialogueData[currentNPC].lines[idx];
            if (!line.sets) line.sets = {};
            
            const flagName = prompt("Enter flag name to set:");
            if (!flagName) return;
            
            line.sets[flagName] = true;
            renderLines();
        }
        
        function updateSetFlagValue(idx, flag, value) {
            const line = dialogueData[currentNPC].lines[idx];
            line.sets[flag] = value === 'true';
            renderLines();
        }
        
        function deleteSetFlag(idx, flag) {
            const line = dialogueData[currentNPC].lines[idx];
            delete line.sets[flag];
            if (Object.keys(line.sets).length === 0) {
                delete line.sets;
            }
            renderLines();
        }
        
        function addLine() {
            dialogueData[currentNPC].lines.push({
                text: "New dialogue line...",
                requires: {},
                sets: {}
            });
            renderLines();
        }
        
        function duplicateLine(idx) {
            const line = JSON.parse(JSON.stringify(dialogueData[currentNPC].lines[idx]));
            line.text += " (Copy)";
            dialogueData[currentNPC].lines.splice(idx + 1, 0, line);
            renderLines();
        }
        
        function deleteLine(idx) {
            if (confirm('Delete this dialogue line?')) {
                dialogueData[currentNPC].lines.splice(idx, 1);
                renderLines();
            }
        }
        
        function moveLine(idx, direction) {
            const lines = dialogueData[currentNPC].lines;
            const newIdx = idx + direction;
            [lines[idx], lines[newIdx]] = [lines[newIdx], lines[idx]];
            renderLines();
        }
        
        function showUsedFlags() {
            const allFlags = new Set();
            
            Object.values(dialogueData).forEach(npc => {
                npc.lines.forEach(line => {
                    if (line.requires?.flags) {
                        Object.keys(line.requires.flags).forEach(flag => allFlags.add(flag));
                    }
                    if (line.sets) {
                        Object.keys(line.sets).forEach(flag => allFlags.add(flag));
                    }
                });
            });
            
            const flagList = Array.from(allFlags).sort().join('\n');
            alert(`All flags used:\n\n${flagList || 'No flags found'}`);
        }
        
        function exportDialogue() {
            const json = JSON.stringify(dialogueData, null, 2);
            document.getElementById('exportArea').value = json;
            
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'dialogue.json';
            a.click();
            URL.revokeObjectURL(url);
        }
        
        function importDialogue() {
            const json = document.getElementById('exportArea').value;
            if (!json.trim()) {
                alert("Paste JSON into the text area first!");
                return;
            }
            
            try {
                dialogueData = JSON.parse(json);
                currentNPC = null;
                renderNPCList();
                document.getElementById('editorArea').innerHTML = '<div class="empty-state">Data imported! Select an NPC to edit.</div>';
                alert("Dialogue imported successfully!");
            } catch (e) {
                alert("Invalid JSON: " + e.message);
            }
        }
        
        init();
    </script>
</body>
</html>